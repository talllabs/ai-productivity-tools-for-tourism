<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tools for Tourism Professionals</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tool-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
                        0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .upvote-btn.upvoted {
            background-color: #2563eb;
            color: white;
            cursor: not-allowed;
        }
        .upvote-btn.upvoted svg {
            fill: white;
        }
        .save-btn svg {
            transition: fill 0.2s, stroke 0.2s;
        }
        .save-btn.saved svg {
            fill: #ef4444;
            stroke: #ef4444;
        }
        .category-link.active {
            background-color: #eef2ff;
            color: #3b82f6;
            font-weight: 600;
        }
        details > summary {
            list-style: none;
            cursor: pointer;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        summary::after {
            content: "▶";
            float: right;
            transform: rotate(0);
            transition: transform 0.2s;
        }
        details[open] > summary::after {
           transform: rotate(90deg);
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .feature-tag-clickable {
            cursor: pointer;
            transition: background-color 0.2s;
        }
    </style>
</head>
<body>
    <!-- ... your HTML for header, search bar, grid container, modals, footer etc. ... -->

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            setPersistence,
            browserLocalPersistence,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            arrayUnion,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDglW5m7u8IFBmeIZTLp8IwxBu5cbvC2s4",
            authDomain: "ai-tools-for-tourism.firebaseapp.com",
            projectId: "ai-tools-for-tourism",
            storageBucket: "ai-tools-for-tourism.firebasestorage.app",
            messagingSenderId: "426723838356",
            appId: "1:426723838356:web:e21c62549ee1e91b16e781",
            measurementId: "G-6Y6FHBS5ZT"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db   = getFirestore(app);

        // In-memory currentUser container
        let currentUser = null;
        let pendingSaveToolId = null;

        // ==== Your existing data and UI helper functions ====
        const toolsData = [ /* … your tools array … */ ];
        // functions: standardizeData(), createFilterCheckboxes(), showGridView(),
        // updateAuthUI(userOrNull), handleSaveClick(id), closeModal(modal), etc.

        // ==== Auth handlers ====
        // Sign-up handler (unchanged except for persistence if desired)
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.elements[0].value;
            const password = e.target.elements[1].value;
            signupError.classList.add('hidden');
            try {
                await setPersistence(auth, browserLocalPersistence);
                await createUserWithEmailAndPassword(auth, email, password);
                closeModal(signupModal);
                e.target.reset();
            } catch (error) {
                signupError.textContent = error.message;
                signupError.classList.remove('hidden');
            }
        });

        // Login handler with explicit persistence
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.elements[0].value;
            const password = e.target.elements[1].value;
            loginError.classList.add('hidden');
            try {
                await setPersistence(auth, browserLocalPersistence);
                await signInWithEmailAndPassword(auth, email, password);
                closeModal(loginModal);
                e.target.reset();
            } catch (error) {
                loginError.textContent = error.message;
                loginError.classList.remove('hidden');
            }
        });

        // Password-reset and sign-out handlers (unchanged)
        resetForm.addEventListener('submit', async (e) => { /* … */ });
        signOutBtn.addEventListener('click', async () => { /* … */ });

        // ==== Initial UI setup (no manual auth/UI calls) ====
        standardizeData();
        createFilterCheckboxes('features', 'features-filter-list');
        createFilterCheckboxes('pricing', 'pricing-filter-list');
        createFilterCheckboxes('bestFor',  'bestfor-filter-list');
        showGridView();
        startPlaceholderRotation();

        // ==== Listen for auth state changes ====
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Load or create the user's Firestore doc
                const userDocRef = doc(db, "users", user.uid);
                const snap = await getDoc(userDocRef);
                let savedArray = [];
                if (snap.exists()) {
                    savedArray = snap.data().savedTools || [];
                } else {
                    await setDoc(userDocRef, { email: user.email, savedTools: [] });
                }

                // Populate our in-memory user
                currentUser = {
                    uid: user.uid,
                    email: user.email,
                    savedTools: new Set(savedArray)
                };

                // Update UI
                updateAuthUI(currentUser);

                // If a save was clicked pre-login, finish it now
                if (pendingSaveToolId) {
                    await handleSaveClick(pendingSaveToolId);
                    pendingSaveToolId = null;
                }
            } else {
                // Signed out
                currentUser = null;
                updateAuthUI(null);
                // If viewing the “saved” tab, reset filters
                if (activeFilters.category === 'saved') {
                    clearAllBtn.click();
                }
            }
        });

        // ==== Rest of your app logic (search/filter, event listeners, etc.) ====
        document.addEventListener('click', (e) => { /* … */ });
        searchInput.addEventListener('input', () => { /* … */ });
        // … and so on …

    </script>
</body>
</html>
